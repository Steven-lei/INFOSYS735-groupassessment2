---
AWSTemplateFormatVersion: "2010-09-09"
Description: CloudFormation template to create a targetGroup and an AutoScalingGroup.
Metadata:
  Comment: "This is a group project for course INFOSYS 735 group assessment2"
  Owner: "Group 15"
Parameters:
  namePrefix:
    Type: String
    Default: AnyGroup
    Description: Prefix for resource names

  VPCId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID where the target group will be created

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: List of Subnet IDs where the target group will be used

  LaunchTemplateId:
    Type: String
    Description: ID of the launch template to be used for the Auto Scaling group

  LaunchTemplateVersion:
    Type: String
    Description: Version of the launch template to be used for the Auto Scaling group

Resources:
  AppTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${namePrefix}-AppTargetGroup"
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPCId
      HealthCheckPath: /
      HealthCheckIntervalSeconds: 10
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 3
      UnhealthyThresholdCount: 2
      TargetType: instance
      Tags:
        - Key: Name
          Value: !Sub "${namePrefix}-AppTargetGroup"

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub "${namePrefix}-AutoScalingGroup"
      VPCZoneIdentifier: !Ref SubnetIds
      TargetGroupARNs:
        - !Ref AppTargetGroup
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplateId
        Version: !Ref LaunchTemplateVersion
      MinSize: 1
      MaxSize: 3
      DesiredCapacity: 2
      Tags:
        - Key: Name
          Value: !Sub "${namePrefix}-AutoScalingInstance"
          PropagateAtLaunch: true

Outputs:
  TargetGroupARN:
    Description: The ARN of the target group
    Value: !Ref AppTargetGroup
    Export:
      Name: !Sub "${AWS::StackName}-AppTargetGroupARN"
